<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix TSL - Flow Control System Maintenance</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
        <h1>Inspiring the Next Generation of Engineers</h1>
      </div>
      <ul class="nav-menu" id="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.location='index.html'" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp0539-worksheets.html'" class="nav-link">
            <i class="fas fa-cogs"></i> CP0539
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='cp6773-worksheets.html'" class="nav-link">
            <i class="fas fa-exclamation-triangle"></i> CP6773
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='settings.html'" class="nav-link">
            <i class="fas fa-gear"></i> SETTINGS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.location='about.html'" class="nav-link">
            <i class="fas fa-info-circle"></i> ABOUT
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="worksheet-box">
    <!-- Integrated Worksheet Header -->
    <div class="worksheet-header">
      <div class="worksheet-header-content">
        <div class="worksheet-header-left">
          <button class="worksheet-nav-btn worksheet-back-btn" onclick="window.location.href='cp0539-worksheets.html'">
            <i class="fas fa-arrow-left"></i>
            <span>Back to Worksheets</span>
          </button>
        </div>
        <div class="worksheet-header-center">
          <h1 class="worksheet-title">Worksheet 1 - Flow Control System Maintenance</h1>
        </div>
        <div class="worksheet-header-right">
          <button class="worksheet-nav-btn worksheet-next-btn" onclick="window.location.href='worksheet-2.html'">
            <span>Next Worksheet</span>
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    <!-- Introduction Section -->
    <div class="worksheet-section introduction-section">
      <h2 class="section-header"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
      <div class="worksheet-content">
        <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
        
        <div class="cad-models">
          <div class="cad-model">
            <img src="assets/cad.png" alt="CAD Model - Front View">
            <figcaption>CAD Model - Front View</figcaption>
          </div>
          <div class="cad-model">
            <img src="assets/cad2.png" alt="CAD Model - Side View">
            <figcaption>CAD Model - Side View</figcaption>
          </div>
        </div>
      </div>
    </div>

    <!-- Over To You Section -->
    <div class="worksheet-section over-to-you-section">
      <h2 class="section-header"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
      <div class="worksheet-content">
        <p><strong>Your task is to examine and maintain the flow control system following these essential procedures:</strong></p>
        
        <div class="steps-container">
          <div class="step-card" data-step="1">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-header">
                <h4>System Overview</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Examine the overall system layout, identifying the pump, valve, flow sensor, and control elements. Understand how they work together in the closed-loop control system.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="2">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Flow Sensor Inspection</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Check the flow sensor for proper mounting, clean sensor face, and verify signal output matches actual flow conditions.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="3">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-header">
                <h4>Control Valve Operation</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Test valve operation by adjusting setpoint and observing valve response. Check for smooth operation and proper positioning.</p>
            </div>
          </div>
          
          <div class="step-card" data-step="4">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-header">
                <h4>PID Controller Tuning</h4>
                <label class="step-checkbox">
                  <input type="checkbox" class="step-complete-checkbox">
                  <span class="checkmark"></span>
                </label>
              </div>
              <p>Use the PID tuning interface to optimize system response. Adjust Proportional, Integral, and Derivative parameters for stable, responsive control.</p>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- So What Section -->
    <div class="worksheet-section so-what-section">
      <h2 class="section-header"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
      <div class="so-what-content">
        <p>Understanding closed-loop flow control systems is fundamental to industrial automation. These systems are everywhere - from water treatment plants to chemical processing facilities.</p>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>Feedback Control</strong>
            <p>The system continuously measures the actual flow and compares it to the desired setpoint, automatically adjusting the control valve to maintain accurate flow control even when conditions change.</p>
          </div>
        </div>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>PID Control</strong>
            <p>The PID controller uses Proportional, Integral, and Derivative actions to provide stable, responsive control without oscillation or steady-state error.</p>
          </div>
        </div>
        
        <div class="key-point">
          <i class="fas fa-lightbulb"></i>
          <div>
            <strong>System Reliability</strong>
            <p>Proper maintenance of sensors, valves, and controllers ensures the system operates reliably, preventing costly production disruptions and maintaining product quality.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Questions Section -->
    <div class="worksheet-section questions-section">
      <h2 class="section-header"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
      <div class="questions-content">
        <div class="instructions">
          <strong>Instructions:</strong> Answer each question based on your observations and understanding of the flow control system. Your answers will be saved automatically.
        </div>
        
        <div class="question-item" data-question="1">
          <h4>Question 1: What is the purpose of a closed-loop flow control system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-1" value="A" class="option-radio">
              <span class="option-text">A) To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="B" class="option-radio">
              <span class="option-text">B) To operate the system manually at all times</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="C" class="option-radio">
              <span class="option-text">C) To increase the system's energy consumption</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-1" value="D" class="option-radio">
              <span class="option-text">D) To reduce the need for sensors</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(1)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
          </div>
        </div>
        <div class="question-item" data-question="2">
          <h4>Question 2: What must you check before starting the system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-2" value="A" class="option-radio">
              <span class="option-text">A) Ensure the hand valve is in the open position, with the handle in line with the piping</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="B" class="option-radio">
              <span class="option-text">B) Ensure the pump is off</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="C" class="option-radio">
              <span class="option-text">C) Ensure the flow sensor is disconnected</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-2" value="D" class="option-radio">
              <span class="option-text">D) Ensure the valve is closed</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(2)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) Ensure the hand valve is in the open position, with the handle in line with the piping.
          </div>
        </div>
        <div class="question-item" data-question="3">
          <h4>Question 3: What happens when you restrict the flow using the hand valve?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-3" value="A" class="option-radio">
              <span class="option-text">A) The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="B" class="option-radio">
              <span class="option-text">B) The system shuts down immediately</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="C" class="option-radio">
              <span class="option-text">C) The valve closes further</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-3" value="D" class="option-radio">
              <span class="option-text">D) The pump turns off</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(3)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
          </div>
        </div>
        <div class="question-item" data-question="4">
          <h4>Question 4: What role does the PLC play in the system?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-4" value="A" class="option-radio">
              <span class="option-text">A) The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="B" class="option-radio">
              <span class="option-text">B) The PLC only displays data on the HMI</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="C" class="option-radio">
              <span class="option-text">C) The PLC is used for manual control only</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-4" value="D" class="option-radio">
              <span class="option-text">D) The PLC is not involved in control</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(4)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
          </div>
        </div>
        <div class="question-item" data-question="5">
          <h4>Question 5: Why should you avoid making rapid changes to the valve?</h4>
          <div class="multiple-choice-options">
            <label class="option-label">
              <input type="radio" name="question-5" value="A" class="option-radio">
              <span class="option-text">A) Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="B" class="option-radio">
              <span class="option-text">B) Rapid changes save energy</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="C" class="option-radio">
              <span class="option-text">C) Rapid changes are required for safety</span>
            </label>
            <label class="option-label">
              <input type="radio" name="question-5" value="D" class="option-radio">
              <span class="option-text">D) Rapid changes increase system accuracy</span>
            </label>
          </div>
          <div class="question-actions">
            <button class="submit-question-btn" onclick="submitAnswer(5)">Submit Answer</button>
          </div>
          <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: #1a2f1a; border-radius: 4px; border-left: 3px solid #4CAF50;">
            <strong style="color: #4CAF50;">Correct Answer:</strong> A) Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
          </div>
        </div>
      </div>
    </div>

    <!-- Interactive PID Simulation -->
    <div class="simulation-section">
      <h2 class="section-header"><i class="fas fa-chart-line"></i> 5. Interactive PID Control System</h2>
      
      <!-- PID Tuning Section -->
      <div id="pid-tuning-container">
        <h3>PID Tuning Controls</h3>
        <div class="pid-controls">
          <div class="control-group">
            <label>Setpoint</label>
            <input type="range" id="setpoint-slider" min="0" max="100" value="50">
            <span id="setpoint-value">50</span>
          </div>
          
          <div class="control-group">
            <label>Proportional (P)</label>
            <input type="range" id="p-gain-slider" min="0" max="5" step="0.1" value="1.0">
            <span id="p-gain-value">1.0</span>
          </div>
          
          <div class="control-group">
            <label>Integral (I)</label>
            <input type="range" id="i-gain-slider" min="0" max="2" step="0.01" value="0.1">
            <span id="i-gain-value">0.1</span>
          </div>
          
          <div class="control-group">
            <label>Derivative (D)</label>
            <input type="range" id="d-gain-slider" min="0" max="1" step="0.01" value="0.05">
            <span id="d-gain-value">0.05</span>
          </div>
          
          <div class="control-buttons">
            <button id="start-simulation-btn">Start Simulation</button>
            <button id="reset-pid-btn">Reset to Defaults</button>
          </div>
        </div>
        
        <div class="pid-chart-container">
          <canvas id="pid-chart" width="800" height="400"></canvas>
        </div>
      </div>
      
      <!-- System Response Analysis Section -->
      <div id="response-analysis-container">
        <h3>System Response Analysis</h3>
        <div class="response-metrics">
          <div class="metric-card">
            <h4>Rise Time</h4>
            <p id="rise-time">--</p>
          </div>
          <div class="metric-card">
            <h4>Settling Time</h4>
            <p id="settling-time">--</p>
          </div>
          <div class="metric-card">
            <h4>Overshoot</h4>
            <p id="overshoot">--</p>
          </div>
          <div class="metric-card">
            <h4>Steady State Error</h4>
            <p id="steady-state-error">--</p>
          </div>
        </div>
        <div class="response-tips">
          <h4>Response Characteristics:</h4>
          <ul>
            <li><strong>Fast Rise Time:</strong> High P gain, but may cause overshoot</li>
            <li><strong>Low Overshoot:</strong> Moderate P gain with some D gain</li>
            <li><strong>No Steady State Error:</strong> Include I gain to eliminate offset</li>
            <li><strong>Stable Response:</strong> Balance all three parameters</li>
          </ul>
        </div>
      </div>
      
      <!-- PID Tuning Challenges Section -->
      <div id="challenges-container">
        <h3>PID Tuning Challenges</h3>
        <div class="challenge-list">
          <div class="challenge-item">
            <h4>Challenge 1: Aggressive Response</h4>
            <p>Set the setpoint to 80 and tune the PID parameters to achieve a fast response with minimal overshoot (less than 5%).</p>
            <button class="challenge-btn" onclick="loadChallenge(1)">Load Challenge</button>
          </div>
          <div class="challenge-item">
            <h4>Challenge 2: Disturbance Rejection</h4>
            <p>Tune the system to maintain the setpoint at 50 despite external disturbances. The system should recover quickly.</p>
            <button class="challenge-btn" onclick="loadChallenge(2)">Load Challenge</button>
          </div>
          <div class="challenge-item">
            <h4>Challenge 3: Conservative Tuning</h4>
            <p>Create a slow but stable response with no overshoot. This is useful for processes that cannot tolerate overshoot.</p>
            <button class="challenge-btn" onclick="loadChallenge(3)">Load Challenge</button>
          </div>
        </div>
      </div>
    </div>
  </div>



    


  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    // Initialize PID simulation
    document.addEventListener('DOMContentLoaded', function() {
      initializePIDControls();
      initializeStepTracking();
      loadSavedAnswers();
    });
    
    // PID simulation variables
    let pidChart = null;
    let simulationRunning = false;
    let simulationData = [];
    

    
    // Initialize PID controls
    function initializePIDControls() {
      // Update slider values
      document.getElementById('setpoint-slider').addEventListener('input', function() {
        document.getElementById('setpoint-value').textContent = this.value;
      });
      
      document.getElementById('p-gain-slider').addEventListener('input', function() {
        document.getElementById('p-gain-value').textContent = this.value;
      });
      
      document.getElementById('i-gain-slider').addEventListener('input', function() {
        document.getElementById('i-gain-value').textContent = this.value;
      });
      
      document.getElementById('d-gain-slider').addEventListener('input', function() {
        document.getElementById('d-gain-value').textContent = this.value;
      });
      
      // Start simulation button
      document.getElementById('start-simulation-btn').addEventListener('click', function() {
        if (!simulationRunning) {
          startPIDSimulation();
        } else {
          stopPIDSimulation();
        }
      });
      
      // Reset button
      document.getElementById('reset-pid-btn').addEventListener('click', function() {
        resetPIDDefaults();
      });
      
      // Initialize chart
      initializePIDChart();
    }
    
    // Initialize PID chart
    function initializePIDChart() {
      const ctx = document.getElementById('pid-chart').getContext('2d');
      pidChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Setpoint',
            data: [],
            borderColor: '#FF5722',
            backgroundColor: 'rgba(255, 87, 34, 0.1)',
            borderWidth: 3,
            fill: false,
            tension: 0.1,
            pointRadius: 0,
            pointHoverRadius: 4
          }, {
            label: 'Process Variable',
            data: [],
            borderColor: 'var(--accent-color)',
            backgroundColor: 'var(--accent-shadow-light)',
            borderWidth: 3,
            fill: false,
            tension: 0.1,
            pointRadius: 0,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 0
          },
          plugins: {
            legend: {
              labels: {
                color: '#FFFFFF',
                font: {
                  size: 14,
                  weight: 'bold'
                },
                usePointStyle: true,
                pointStyle: 'circle'
              },
              position: 'top'
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FFFFFF',
              bodyColor: '#FFFFFF',
              borderColor: '#555',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Time (s)',
                color: '#FFFFFF',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              ticks: {
                color: '#FFFFFF',
                font: {
                  size: 12
                }
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)',
                drawBorder: false
              }
            },
            y: {
              title: {
                display: true,
                text: 'Value (%)',
                color: '#FFFFFF',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              min: 0,
              max: 100,
              ticks: {
                color: '#FFFFFF',
                font: {
                  size: 12
                },
                stepSize: 20
              },
              grid: {
                color: 'rgba(255, 255, 255, 0.1)',
                drawBorder: false
              }
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }
    
    // Start PID simulation
    function startPIDSimulation() {
      simulationRunning = true;
      document.getElementById('start-simulation-btn').textContent = 'Stop Simulation';
      
      // Clear previous data
      simulationData = [];
      pidChart.data.labels = [];
      pidChart.data.datasets[0].data = [];
      pidChart.data.datasets[1].data = [];
      
      // Reset PID simulation state
      if (simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      
      // Start simulation loop
      let time = 0;
      const interval = setInterval(() => {
        if (!simulationRunning) {
          clearInterval(interval);
          return;
        }
        
        // Get PID parameters
        const setpoint = parseFloat(document.getElementById('setpoint-slider').value);
        const kp = parseFloat(document.getElementById('p-gain-slider').value);
        const ki = parseFloat(document.getElementById('i-gain-slider').value);
        const kd = parseFloat(document.getElementById('d-gain-slider').value);
        
        // Simple PID simulation
        const processVariable = simulatePIDResponse(setpoint, kp, ki, kd, time);
        
        // Add data to chart
        pidChart.data.labels.push(time);
        pidChart.data.datasets[0].data.push(setpoint);
        pidChart.data.datasets[1].data.push(processVariable);
        
        // Limit data points
        if (pidChart.data.labels.length > 100) {
          pidChart.data.labels.shift();
          pidChart.data.datasets[0].data.shift();
          pidChart.data.datasets[1].data.shift();
        }
        
        pidChart.update('none');
        time++;
        
        // Update metrics every 10 time steps
        if (time % 10 === 0) {
          calculateResponseMetrics();
        }
      }, 100);
    }
    
    // Stop PID simulation
    function stopPIDSimulation() {
      simulationRunning = false;
      document.getElementById('start-simulation-btn').textContent = 'Start Simulation';
    }
    
    // Enhanced PID response simulation
    function simulatePIDResponse(setpoint, kp, ki, kd, time) {
      // Initialize static variables for integral and previous error
      if (!simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (!simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (!simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      
      // Calculate error
      const error = setpoint - simulatePIDResponse.previousOutput;
      
      // PID calculations
      const proportional = kp * error;
      simulatePIDResponse.integral += ki * error * 0.1; // 0.1 is time step
      const derivative = kd * (error - simulatePIDResponse.previousError) / 0.1;
      
      // Calculate output
      let output = proportional + simulatePIDResponse.integral + derivative;
      
      // Add realistic system dynamics (first-order system)
      const tau = 5; // Time constant
      const dt = 0.1; // Time step
      output = simulatePIDResponse.previousOutput + (output - simulatePIDResponse.previousOutput) * (1 - Math.exp(-dt / tau));
      
      // Add some realistic noise and disturbance
      const noise = (Math.random() - 0.5) * 1;
      const disturbance = Math.sin(time * 0.05) * 2; // Slow disturbance
      
      output += noise + disturbance;
      
      // Update previous values
      simulatePIDResponse.previousError = error;
      simulatePIDResponse.previousOutput = output;
      
      // Ensure output stays within 0-100 range
      return Math.max(0, Math.min(100, output));
    }
    
    // Reset PID to defaults
    function resetPIDDefaults() {
      document.getElementById('setpoint-slider').value = 50;
      document.getElementById('setpoint-value').textContent = '50';
      document.getElementById('p-gain-slider').value = 1.0;
      document.getElementById('p-gain-value').textContent = '1.0';
      document.getElementById('i-gain-slider').value = 0.1;
      document.getElementById('i-gain-value').textContent = '0.1';
      document.getElementById('d-gain-slider').value = 0.05;
      document.getElementById('d-gain-value').textContent = '0.05';
      
      // Reset PID simulation state
      if (simulatePIDResponse.integral) simulatePIDResponse.integral = 0;
      if (simulatePIDResponse.previousError) simulatePIDResponse.previousError = 0;
      if (simulatePIDResponse.previousOutput) simulatePIDResponse.previousOutput = 0;
      
      stopPIDSimulation();
    }
    
    // Initialize step tracking
    function initializeStepTracking() {
      const checkboxes = document.querySelectorAll('.step-complete-checkbox');
      checkboxes.forEach((checkbox, index) => {
        checkbox.addEventListener('change', function() {
          const stepCard = this.closest('.step-card');
          if (this.checked) {
            stepCard.style.borderLeftColor = '#4CAF50';
            stepCard.style.opacity = '0.8';
          } else {
            stepCard.style.borderLeftColor = '#4CAF50';
            stepCard.style.opacity = '1';
          }
          
          // Save step completion
          localStorage.setItem(`worksheet1_step${index + 1}`, this.checked);
        });
        
        // Load saved step completion
        const saved = localStorage.getItem(`worksheet1_step${index + 1}`);
        if (saved === 'true') {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change'));
        }
      });
    }
    
    // Submit answer
    function submitAnswer(questionNumber) {
      const questionItem = document.querySelector(`[data-question="${questionNumber}"]`);
      const selectedOption = questionItem.querySelector('.option-radio:checked');
      const answer = selectedOption ? selectedOption.value : '';
      
      if (answer) {
        // Define correct answers for worksheet 1
        const correctAnswers = {
          1: 'A', // To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
          2: 'A', // Ensure the hand valve is in the open position, with the handle in line with the piping.
          3: 'A', // The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
          4: 'A', // The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
          5: 'A'  // Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
        };
        
        // Save answer
        localStorage.setItem(`worksheet1_answer${questionNumber}`, answer);
        
        // Apply visual feedback
        const allOptions = questionItem.querySelectorAll('.option-label');
        const correctAnswer = correctAnswers[questionNumber];
        
        allOptions.forEach(option => {
          const radio = option.querySelector('.option-radio');
          const optionValue = radio.value;
          
          if (optionValue === correctAnswer) {
            option.classList.add('correct');
          } else if (optionValue === answer && answer !== correctAnswer) {
            option.classList.add('incorrect');
          }
        });
        
        // Mark question as submitted to disable further interaction
        questionItem.classList.add('submitted');
        
        // Show confirmation
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = answer === correctAnswer ? 'Correct!' : 'Incorrect!';
        button.style.background = answer === correctAnswer ? '#4CAF50' : '#f44336';
        
        // Add incorrect class for enhanced styling
        if (answer !== correctAnswer) {
          button.classList.add('incorrect');
        }
        
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = '';
          button.classList.remove('incorrect');
        }, 2000);

        // Show correct answer
        const correctAnswerDiv = questionItem.querySelector('.correct-answer');
        correctAnswerDiv.style.display = 'block';

      } else {
        alert('Please select an answer before submitting.');
      }
    }
    
    // Load saved answers
    function loadSavedAnswers() {
      // Define correct answers for worksheet 1
      const correctAnswers = {
        1: 'A', // To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
        2: 'A', // Ensure the hand valve is in the open position, with the handle in line with the piping.
        3: 'A', // The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
        4: 'A', // The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
        5: 'A'  // Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
      };
      
      for (let i = 1; i <= 5; i++) {
        const saved = localStorage.getItem(`worksheet1_answer${i}`);
        if (saved) {
          const questionItem = document.querySelector(`[data-question="${i}"]`);
          if (questionItem) {
            const selectedOption = questionItem.querySelector(`.option-radio[value="${saved}"]`);
            if (selectedOption) {
              selectedOption.checked = true;
              
              // Apply visual feedback for saved answers
              const allOptions = questionItem.querySelectorAll('.option-label');
              const correctAnswer = correctAnswers[i];
              
              allOptions.forEach(option => {
                const radio = option.querySelector('.option-radio');
                const optionValue = radio.value;
                
                if (optionValue === correctAnswer) {
                  option.classList.add('correct');
                } else if (optionValue === saved && saved !== correctAnswer) {
                  option.classList.add('incorrect');
                }
              });
              
              // Mark question as submitted to disable further interaction
              questionItem.classList.add('submitted');
              
              // Show correct answer
              const correctAnswerDiv = questionItem.querySelector('.correct-answer');
              correctAnswerDiv.style.display = 'block';
            }
          }
        }
      }
    }
    
    // Load PID tuning challenges
    function loadChallenge(challengeNumber) {
      const challenges = {
        1: { setpoint: 80, p: 2.0, i: 0.05, d: 0.1, description: 'Aggressive Response Challenge' },
        2: { setpoint: 50, p: 1.5, i: 0.2, d: 0.05, description: 'Disturbance Rejection Challenge' },
        3: { setpoint: 60, p: 0.8, i: 0.1, d: 0.2, description: 'Conservative Tuning Challenge' }
      };
      
      const challenge = challenges[challengeNumber];
      if (challenge) {
        // Set the parameters
        document.getElementById('setpoint-slider').value = challenge.setpoint;
        document.getElementById('setpoint-value').textContent = challenge.setpoint;
        document.getElementById('p-gain-slider').value = challenge.p;
        document.getElementById('p-gain-value').textContent = challenge.p;
        document.getElementById('i-gain-slider').value = challenge.i;
        document.getElementById('i-gain-value').textContent = challenge.i;
        document.getElementById('d-gain-slider').value = challenge.d;
        document.getElementById('d-gain-value').textContent = challenge.d;
        
        alert(`Loaded ${challenge.description}. Try to improve the response!`);
      }
    }
    
    // Calculate response metrics
    function calculateResponseMetrics() {
      if (!pidChart || pidChart.data.datasets[1].data.length === 0) return;
      
      const setpointData = pidChart.data.datasets[0].data;
      const processData = pidChart.data.datasets[1].data;
      const setpoint = setpointData[setpointData.length - 1];
      
      // Calculate rise time (time to reach 90% of setpoint)
      const target90 = setpoint * 0.9;
      let riseTime = 0;
      for (let i = 0; i < processData.length; i++) {
        if (processData[i] >= target90) {
          riseTime = i;
          break;
        }
      }
      
      // Calculate overshoot
      const maxValue = Math.max(...processData);
      const overshoot = maxValue > setpoint ? ((maxValue - setpoint) / setpoint) * 100 : 0;
      
      // Calculate settling time (time to stay within 2% of setpoint)
      const targetRange = setpoint * 0.02;
      let settlingTime = 0;
      for (let i = processData.length - 1; i >= 0; i--) {
        if (Math.abs(processData[i] - setpoint) > targetRange) {
          settlingTime = i;
          break;
        }
      }
      
      // Calculate steady state error
      const finalValue = processData[processData.length - 1];
      const steadyStateError = Math.abs(finalValue - setpoint);
      
      // Update display
      document.getElementById('rise-time').textContent = riseTime + ' s';
      document.getElementById('settling-time').textContent = settlingTime + ' s';
      document.getElementById('overshoot').textContent = overshoot.toFixed(1) + '%';
      document.getElementById('steady-state-error').textContent = steadyStateError.toFixed(2);
    }
  </script>
</body>
</html> 