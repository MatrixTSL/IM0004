<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Matrix Training Platform - Worksheet</title>
  <link rel="stylesheet" href="main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="icon" type="image/x-icon" href="assets/icons/matrix-icon.ico">
  
  <style>
    /* Worksheet Box Styling */
    .worksheet-box {
      max-width: 1200px;
      margin: 20px auto;
      background: #2d2d2d;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      border: 1px solid #444;
    }

    /* Navigation Buttons */
    .worksheet-navigation {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #444;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 160px;
      justify-content: center;
    }

    .nav-btn:hover {
      background: linear-gradient(135deg, #45a049, #4CAF50);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }

    .nav-btn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .back-to-list-btn {
      background: linear-gradient(135deg, #2196F3, #1976D2);
    }

    .back-to-list-btn:hover {
      background: linear-gradient(135deg, #1976D2, #2196F3);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .worksheet-box {
        margin: 10px;
        padding: 20px;
      }
      
      .worksheet-navigation {
        flex-direction: column;
        gap: 10px;
      }
      
      .nav-btn {
        width: 100%;
        max-width: 300px;
      }
    }

    /* Improve content spacing within the box */
    .worksheet-box .page-title {
      margin-top: 0;
      margin-bottom: 30px;
    }

    .worksheet-box .worksheet-section {
      margin-bottom: 30px;
    }

    .worksheet-box .so-what-section {
      margin-top: 30px;
      margin-bottom: 30px;
    }

    /* Hidden class for tab system */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="main-navigation">
    <div class="nav-container">
      <div class="nav-logo">
        <img src="assets/matrix-logo.png" alt="Matrix Logo">
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('index.html')" class="nav-link">
            <i class="fas fa-home"></i> HOME
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('worksheets.html')" class="nav-link active">
            <i class="fas fa-book-open"></i> WORKSHEETS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('plc-controls.html')" class="nav-link">
            <i class="fas fa-cogs"></i> PLC CONTROLS
          </a>
        </li>
        <li class="nav-item">
          <a href="#" onclick="window.electron.navigate('settings.html')" class="nav-link">
            <i class="fas fa-gear"></i> SETTINGS
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Loading State -->
  <div id="loading-container" class="loading-container">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Loading worksheet...</p>
    </div>
  </div>

  <!-- Error State -->
  <div id="error-container" class="error-container" style="display: none;">
    <h3><i class="fas fa-exclamation-triangle"></i> Worksheet Not Found</h3>
    <p>The requested worksheet could not be loaded.</p>
    <button class="back-btn" onclick="window.electron.navigate('worksheets.html')">
      <i class="fas fa-arrow-left"></i> Back to Worksheets
    </button>
  </div>

  <!-- Main Content -->
  <div id="main-content" class="worksheet-container" style="display: none;">
    <!-- Back Navigation -->
    <div class="back-nav">
      <button class="back-btn" onclick="window.electron.navigate('worksheets.html')">
        <i class="fas fa-arrow-left"></i> Back to Worksheets
      </button>
    </div>

    <!-- Boxed Worksheet Content -->
    <div class="worksheet-box">
      <!-- Dynamic Content Will Be Loaded Here -->
      <div id="worksheet-content"></div>
      
      <!-- Navigation Buttons -->
      <div class="worksheet-navigation">
        <button class="nav-btn prev-btn" onclick="navigateWorksheet('prev')">
          <i class="fas fa-chevron-left"></i> Previous Worksheet
        </button>
        <button class="nav-btn next-btn" onclick="navigateWorksheet('next')">
          Next Worksheet <i class="fas fa-chevron-right"></i>
        </button>
        <button class="nav-btn back-to-list-btn" onclick="window.electron.navigate('worksheets.html')">
          <i class="fas fa-list"></i> All Worksheets
        </button>
      </div>
    </div>
  </div>

  <!-- Load dependencies -->
  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="scenario-popup.js"></script>
  
  <script>
    console.log('Scripts loaded, checking for functions...');
    console.log('showInteractiveWorksheet1 available:', typeof showInteractiveWorksheet1);
    console.log('window.showInteractiveWorksheet1 available:', typeof window.showInteractiveWorksheet1);
  </script>
  
  <script>
    // Get URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Load worksheet data
    async function loadWorksheet() {
      try {
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        
        if (!worksheetId) {
          showError('No worksheet ID specified');
          return;
        }

        // Load data for worksheets
        const filename = type === 'fault' ? 'dbFaultScenarios.json' : 'dbMaintenanceScenarios.json';
        const response = await fetch(filename);
        const data = await response.json();
        
        const scenario = data.scenarios.find(s => s.id === parseInt(worksheetId));
        if (!scenario) {
          showError('Worksheet not found');
          return;
        }

        // Check if this worksheet has a special function to call
        if (scenario.functionCall && window[scenario.functionCall]) {
          console.log(`Calling special function: ${scenario.functionCall}`);
          // Call the special interactive function directly to the worksheet container
          renderInteractiveWorksheet1();
        } else if (scenario.functionCall) {
          console.warn(`Function ${scenario.functionCall} not found, using fallback`);
          // Function specified but not found, use fallback
          renderWorksheet1Fallback();
        } else {
          // Regular worksheet with JSON content
          renderWorksheet(scenario, type);
        }
        
      } catch (error) {
        console.error('Error loading worksheet:', error);
        showError('Failed to load worksheet');
      } finally {
        // Update navigation buttons for all worksheets
        setTimeout(updateNavigationButtons, 100);
      }
    }

    // Render the interactive Worksheet 1 content directly to the container
    function renderInteractiveWorksheet1() {
      const container = document.getElementById('worksheet-content');
      
      try {
        // Create the worksheet content directly (without popup)
        container.innerHTML = `
          <h1 class="page-title">Closed-Loop Control Systems</h1>

          <div class="worksheet-section introduction-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #2196F3; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.2);">
            <h2 class="section-header" style="color: #2196F3; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-info-circle"></i> 1. Introduction</h2>
            <div class="worksheet-content">
              <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
              
              <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
                <figure style="text-align: center;">
                  <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                  <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
                </figure>
                <figure style="text-align: center;">
                  <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                  <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
                </figure>
              </div>
            </div>
          </div>

          <div class="worksheet-section over-to-you-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #FF9800; box-shadow: 0 8px 20px rgba(255, 152, 0, 0.2);">
            <h2 class="section-header" style="color: #FF9800; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-hands-helping"></i> 2. Over To You</h2>
            <div class="worksheet-content">
              <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
              
              <div class="steps-container">
                <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                  </div>
                </div>

                <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                  </div>
                </div>

                <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                  </div>
                </div>

                <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                  <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                  <div class="step-content" style="flex: 1;">
                    <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                      <label class="step-checkbox">
                        <input type="checkbox" class="step-complete-checkbox">
                        <span class="checkmark" style="margin-left: 10px;"></span>
                      </label>
                    </div>
                    <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="so-what-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; margin-bottom: 40px; border: 2px solid #9C27B0; box-shadow: 0 8px 20px rgba(156, 39, 176, 0.2);">
            <h2 class="section-header" style="color: #9C27B0; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-lightbulb"></i> 3. So What?</h2>
            <div class="so-what-content">
              <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-lightbulb" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Feedback Control</strong>
                  <p style="color: #FFFFFF; margin: 0;">The system continuously measures the actual flow rate and compares it to the desired setpoint. If there's a difference, it automatically adjusts the pump speed or valve position to correct it.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-cogs" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Real-Time Automation</strong>
                  <p style="color: #FFFFFF; margin: 0;">The PLC processes sensor data and makes control decisions in milliseconds, far faster than any human could react. This ensures consistent, accurate control even when conditions change.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-shield-alt" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Stability & Reliability</strong>
                  <p style="color: #FFFFFF; margin: 0;">Closed-loop systems are self-correcting. If something tries to disturb the process (like partially closing a valve), the system automatically compensates to maintain the desired flow rate.</p>
                </div>
              </div>
              
              <div class="key-point" style="display: flex; align-items: flex-start; gap: 15px; margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
                <i class="fas fa-industry" style="color: #4CAF50; font-size: 20px; margin-top: 5px;"></i>
                <div>
                  <strong style="color: #FFFFFF; display: block; margin-bottom: 5px;">Industrial Applications</strong>
                  <p style="color: #FFFFFF; margin: 0;">These principles are used everywhere in industry - from temperature control in manufacturing to pressure regulation in chemical plants. Understanding this system gives you insight into how modern automation works.</p>
                </div>
              </div>
            </div>
          </div>

                     <div class="questions-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-bottom: 40px; border: 2px solid #4CAF50; box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);">
            <h2 class="section-header" style="color: #4CAF50; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-question-circle"></i> 4. Questions & Answers</h2>
            <div class="questions-content">
              <div class="instructions" style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #FFFFFF;">
                <strong>Instructions:</strong> Answer each question based on your observations and understanding of the closed-loop control system. Click "Submit Answer" for each question to see how your response compares to the correct answer.
              </div>
              
              <div class="question-item" data-question="1" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 1: What is the main purpose of a closed-loop control system?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Think about what you observed when you set the flow rate and how the system responded.</p>
                <textarea class="answer-input" data-question="1" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(1)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="2" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 2: Before starting the system, what important check should you perform with the hand valve?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Refer to the initial instructions in the "Over To You" section.</p>
                <textarea class="answer-input" data-question="2" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(2)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="3" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 3: What happens when you introduce a disturbance (like partially closing the shut-off valve)?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Describe the sequence of events you observed when you restricted the flow.</p>
                <textarea class="answer-input" data-question="3" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(3)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
              
              <div class="question-item" data-question="4" style="background: #333; padding: 20px; margin-bottom: 20px; border-radius: 8px;">
                <h4 style="color: #FFFFFF; margin-bottom: 10px;">Question 4: Why is it important to understand closed-loop control systems in industrial maintenance?</h4>
                <p style="color: #FFFFFF; margin-bottom: 15px;">Consider the practical applications and benefits you learned about in the "So What?" section.</p>
                <textarea class="answer-input" data-question="4" placeholder="Enter your answer here..." style="width: 100%; height: 100px; padding: 10px; border: 1px solid #555; border-radius: 4px; background: #222; color: #FFFFFF; resize: vertical;"></textarea>
                <div class="question-actions" style="margin-top: 15px;">
                  <button class="submit-question-btn" onclick="submitQuestion(4)" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Submit Answer</button>
                  <span class="submit-note" style="color: #AAA; margin-left: 10px;">Your answer will be saved and compared to the correct answer.</span>
                </div>
                <div class="individual-comparison hidden"></div>
              </div>
            </div>
          </div>

          <div class="simulation-section" style="background: linear-gradient(135deg, #1a1a1a, #2d2d2d); border-radius: 12px; padding: 30px; margin-top: 40px; border: 2px solid #E91E63; box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);">
            <h2 class="section-header" style="color: #E91E63; margin-bottom: 25px; font-size: 24px; display: flex; align-items: center; gap: 10px;"><i class="fas fa-chart-line"></i> 5. PID Control Simulation</h2>
            
            <!-- Tab navigation for different simulation features -->
            <div class="simulation-tabs" style="display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap;">
                <button class="tab-button active" data-tab="tuning" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">PID Tuning</button>
                <button class="tab-button" data-tab="response" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">System Response</button>
                <button class="tab-button" data-tab="challenges" style="background: #555; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Challenges</button>
            </div>

            <!-- PID Tuning Interface -->
            <div class="tab-content" id="tuning-tab">
                <!-- Main control panel for setpoint and process variable -->
                <div class="control-panel" style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; background: #333; padding: 20px; border-radius: 8px;">
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Setpoint:</label>
                        <input type="range" id="setpoint-slider" min="0" max="100" value="50" style="width: 150px;">
                        <span id="setpoint-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 60px;">50.0°C</span>
                    </div>
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; min-width: 80px; font-weight: bold;">Process Variable:</label>
                        <span id="pv-value" class="value-display" style="color: #2196F3; font-weight: bold; min-width: 60px;">25.0°C</span>
                    </div>
                </div>

                <!-- PID Parameter Tuning Panel -->
                <div class="pid-tuning-panel" style="background: #333; padding: 25px; border-radius: 8px; margin-bottom: 25px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px; font-size: 18px;">PID Parameters</h4>
                    <div class="tuning-controls" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px;">
                        <!-- Proportional control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Proportional (Kp):</label>
                            <input type="range" id="kp-slider" min="0" max="2" step="0.1" value="0.5" style="flex: 1;">
                            <span id="kp-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.5</span>
                        </div>
                        <!-- Integral control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Integral (Ki):</label>
                            <input type="range" id="ki-slider" min="0" max="1" step="0.05" value="0.1" style="flex: 1;">
                            <span id="ki-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.1</span>
                        </div>
                        <!-- Derivative control -->
                        <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; min-width: 120px; font-weight: bold;">Derivative (Kd):</label>
                            <input type="range" id="kd-slider" min="0" max="1" step="0.05" value="0.2" style="flex: 1;">
                            <span id="kd-value" class="value-display" style="color: #E91E63; font-weight: bold; min-width: 50px;">0.2</span>
                        </div>
                    </div>
                    <!-- Real-time performance metrics display -->
                    <div class="performance-metrics" style="display: flex; gap: 30px; flex-wrap: wrap; background: #222; padding: 20px; border-radius: 8px;">
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Rise Time:</label>
                            <span id="rise-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                        </div>
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Overshoot:</label>
                            <span id="overshoot" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0%</span>
                        </div>
                        <div class="metric" style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #FFFFFF; font-weight: bold;">Settling Time:</label>
                            <span id="settling-time" class="metric-value" style="color: #E91E63; font-weight: bold; font-size: 16px;">0.0s</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Response Testing Interface -->
            <div class="tab-content hidden" id="response-tab">
                <div class="response-controls" style="display: flex; gap: 20px; align-items: center; margin-bottom: 25px; background: #333; padding: 20px; border-radius: 8px;">
                    <div class="control-group" style="display: flex; align-items: center; gap: 10px;">
                        <label style="color: #FFFFFF; font-weight: bold;">Input Type:</label>
                        <select id="input-type" style="padding: 8px; border-radius: 4px; border: 1px solid #555; background: #222; color: #FFFFFF; font-weight: bold;">
                            <option value="step">Step</option>
                            <option value="ramp">Ramp</option>
                            <option value="sine">Sinusoidal</option>
                        </select>
                    </div>
                    <button id="start-response" class="action-button" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                        Start Test
                    </button>
                </div>
                <div class="response-graphs">
                    <canvas id="response-canvas" class="simulation-canvas" width="800" height="300" style="background: #222; border-radius: 8px; width: 100%; max-width: 800px; height: 300px; border: 2px solid #555;"></canvas>
                </div>
            </div>

            <!-- Interactive Challenges Interface -->
            <div class="tab-content hidden" id="challenges-tab">
                <div class="challenge-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px;">
                    <!-- Challenge 1: Minimal Overshoot -->
                    <div class="challenge-card" data-challenge="1" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-target"></i> Challenge 1: Minimal Overshoot</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Tune the system to achieve less than 5% overshoot</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                    <!-- Challenge 2: Fast Response -->
                    <div class="challenge-card" data-challenge="2" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-tachometer-alt"></i> Challenge 2: Fast Response</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Achieve settling time under 3 seconds</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                    <!-- Challenge 3: Disturbance Rejection -->
                    <div class="challenge-card" data-challenge="3" style="background: #333; padding: 25px; border-radius: 12px; border: 2px solid #E91E63; transition: all 0.3s ease;">
                        <h4 style="color: #E91E63; margin-bottom: 15px; font-size: 18px;"><i class="fas fa-shield-alt"></i> Challenge 3: Disturbance Rejection</h4>
                        <p style="color: #FFFFFF; margin-bottom: 20px; line-height: 1.5;">Maintain stable control with random disturbances</p>
                        <button class="start-challenge" style="background: #E91E63; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">Start Challenge</button>
                    </div>
                </div>
            </div>

            <!-- Main simulation canvas for real-time visualization -->
            <canvas id="simulation-canvas" class="simulation-canvas" width="800" height="200" style="background: #222; border-radius: 8px; width: 100%; max-width: 800px; height: 200px; margin: 25px 0; border: 2px solid #555;"></canvas>
          </div>
        `;
        
        // Initialize the interactive features
        initializeInteractiveFeatures();
        
        // Initialize PID simulation
        setTimeout(() => {
          if (typeof initEnhancedPIDSimulation === 'function') {
            initEnhancedPIDSimulation();
          }
        }, 100);
        
        // Show the content
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        
        // Update navigation buttons
        setTimeout(updateNavigationButtons, 100);
        
      } catch (error) {
        console.error('Error rendering interactive worksheet:', error);
        renderWorksheet1Fallback();
      }
    }

    // Fallback function to render Worksheet 1 with basic content
    function renderWorksheet1Fallback() {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">
          Worksheet 1: Closed-Loop Control Systems
        </h1>

        <div class="worksheet-section introduction-section">
          <h2 class="section-header">1. Introduction</h2>
          <div class="worksheet-content">
            <p>The system you have in front of you is a Closed-Loop Flow Control system, meaning it continuously adjusts itself to meet a desired target, called the setpoint. It does this by using feedback from sensors to control devices like pumps and valves, keeping the system accurate and stable even if conditions change.</p>
            
            <div class="cad-images" style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
              <figure style="text-align: center;">
                <img src="assets/cad.png" alt="CAD Diagram 1" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Front View</figcaption>
              </figure>
              <figure style="text-align: center;">
                <img src="assets/cad2.png" alt="CAD Diagram 2" style="max-width: 300px; height: auto; border-radius: 4px;">
                <figcaption style="color: #FFFFFF; margin-top: 10px;">CAD Model - Side View</figcaption>
              </figure>
            </div>
          </div>
        </div>

        <div class="worksheet-section over-to-you-section">
          <h2 class="section-header">2. Over To You</h2>
          <div class="worksheet-content">
            <p style="color: #FFFFFF; margin-bottom: 20px; font-weight: bold;">Select Start and observe the system start up. Once the pump is running you should see water flow through the flow gauge. Ensure the hand valve is in the open position, (the handle should be in line with the piping).</p>
            
            <div class="steps-container">
              <div class="step-card" data-step="1" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Set a Flow Rate</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Enter a target flow rate on the HMI. You can adjust in increments of 20 using the +/- buttons.</p>
                </div>
              </div>

              <div class="step-card" data-step="2" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Observe Feedback</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Watch the flow sensor reading on the HMI and compare it to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="3" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Watch the System Adjust</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Note how the pump speed and valve position change to bring the flow rate to the setpoint.</p>
                </div>
              </div>

              <div class="step-card" data-step="4" style="background: #333; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4CAF50; display: flex; align-items: flex-start; gap: 15px; cursor: pointer;">
                <div class="step-number" style="background: #4CAF50; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                <div class="step-content" style="flex: 1;">
                  <div class="step-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4 style="color: #FFFFFF; margin: 0;">Introduce a Disturbance</h4>
                    <label class="step-checkbox">
                      <input type="checkbox" class="step-complete-checkbox">
                      <span class="checkmark" style="margin-left: 10px;"></span>
                    </label>
                  </div>
                  <p style="color: #FFFFFF; margin: 0;">Temporarily restrict the flow (e.g., partially close the shut-off valve) and observe how the system reacts to maintain the flow rate.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="so-what-section" style="background: #2d2d2d; border-radius: 8px; padding: 20px; margin-top: 30px; border-left: 4px solid #4CAF50;">
          <h2 class="section-header" style="color: #FFFFFF; margin-bottom: 20px;">So What?</h2>
          <div class="so-what-content">
            <p style="color: #FFFFFF; margin-bottom: 20px;">This is part of a control system, which automates processes in Industry. At the heart of this system is a PLC (Programmable Logic Controller), a computer that makes real-time decisions based on sensor data. The HMI (Human-Machine Interface) allows you to monitor and adjust settings easily.</p>
            
            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-lightbulb" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Control Loop in Action:</strong>
                <p style="margin: 0; color: #FFFFFF;">Restricting the hand valve reduced flow, which the sensor detected and sent to the PLC. The PLC increased pump speed and adjusted the valve to restore flow, showing automatic correction.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">System Behavior:</strong>
                <p style="margin: 0; color: #FFFFFF;">Rapid valve changes caused oscillations, highlighting the need for gradual adjustments. Fully closing the valve stopped flow; the PLC responded by maxing the pump and opening the valve, but no water moved.</p>
              </div>
            </div>

            <div class="key-point" style="display: flex; gap: 15px; margin-bottom: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 6px;">
              <i class="fas fa-info-circle" style="font-size: 24px; color: #4CAF50; margin-top: 4px;"></i>
              <div>
                <strong style="display: block; color: #4CAF50; margin-bottom: 8px; font-size: 18px;">Important Takeaway:</strong>
                <p style="margin: 0; color: #FFFFFF;">This demonstrates risks like pressure buildup and why managing flow restrictions is critical.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="worksheet-section">
          <h2 class="section-header">Questions and Answers</h2>
          <div class="questions-section">
            <div class="question-item" data-question="1" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">1. What is the purpose of a closed-loop control system?</div>
              <textarea class="answer-input" data-question="1" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(1)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> To continuously adjust flow using sensor feedback to meet a setpoint, maintaining accuracy and stability even if conditions change.
              </div>
            </div>

            <div class="question-item" data-question="2" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">2. What should you ensure about the hand valve before starting the system?</div>
              <textarea class="answer-input" data-question="2" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(2)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Ensure the hand valve is in the open position, with the handle in line with the piping.
              </div>
            </div>

            <div class="question-item" data-question="3" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">3. What happens when you restrict the flow by partially closing the shut-off valve?</div>
              <textarea class="answer-input" data-question="3" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(3)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The flow drops, the sensor detects this and sends data to the PLC, which increases pump speed and adjusts the valve to restore flow.
              </div>
            </div>

            <div class="question-item" data-question="4" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">4. What is the role of the PLC in this system?</div>
              <textarea class="answer-input" data-question="4" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(4)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> The PLC is a computer that makes real-time decisions based on sensor data to control devices like pumps and valves.
              </div>
            </div>

            <div class="question-item" data-question="5" style="background: #333; border-radius: 6px; padding: 20px; margin-bottom: 20px;">
              <div class="question-text" style="color: #FFFFFF; margin-bottom: 15px; font-size: 16px;">5. Why can rapid valve changes cause problems?</div>
              <textarea class="answer-input" data-question="5" placeholder="Enter your answer here..." style="width: 100%; min-height: 80px; padding: 12px; border: 2px solid #555; border-radius: 4px; background: #1a1a1a; color: #FFFFFF; font-size: 14px; resize: vertical;"></textarea>
              <button class="submit-question-btn" onclick="submitWorksheet1Question(5)" style="background: #2196F3; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-top: 10px; cursor: pointer;">Submit Answer</button>
              <div class="correct-answer" style="display: none; margin-top: 15px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 4px; border-left: 3px solid #4CAF50;">
                <strong style="color: #4CAF50;">Correct Answer:</strong> Rapid changes can cause oscillations in flow, making the system unstable; gradual adjustments help maintain smooth control.
              </div>
            </div>
          </div>
        </div>

        <div class="note" style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #FFC107; padding: 15px; margin-top: 20px; border-radius: 4px;">
          <p style="color: #FFC107; margin: 0; font-style: italic;"><strong>Note:</strong> This is a simplified version of Worksheet 1. The full interactive version with PID simulation is temporarily unavailable.</p>
        </div>
      `;

      // Initialize basic step completion functionality
      initializeBasicWorksheet1Features();
      
      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
      
      // Update navigation buttons
      setTimeout(updateNavigationButtons, 100);
    }

    // Initialize the original Worksheet 1 features
    function initializeOriginalWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.classList.add('step-completed');
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.classList.add('step-completed');
          } else {
            card.classList.remove('step-completed');
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize tab system if present
      if (typeof initTabSystem === 'function') {
        initTabSystem();
      }
      
      // Initialize PID simulation if present
      if (typeof initEnhancedPIDSimulation === 'function') {
        initEnhancedPIDSimulation();
      }
    }

    // Render regular worksheet from JSON data
    function renderWorksheet(scenario, type) {
      const container = document.getElementById('worksheet-content');
      
      container.innerHTML = `
        <h1 class="page-title">
          ${type === 'fault' ? 'Fault Scenario' : 'Worksheet'} ${scenario.id}: ${scenario.title}
        </h1>

        <div class="worksheet-section">
          <h2 class="section-header">Scenario Description</h2>
          <div class="worksheet-content">
            ${scenario.paragraphs.map(p => `<p>${p}</p>`).join('')}
          </div>
        </div>

        ${scenario.image ? `
        <div class="worksheet-section">
          <h2 class="section-header">System Diagram</h2>
          <div class="worksheet-content">
            <img src="assets/${type === 'fault' ? 'scenarios' : 'maintenance'}/${scenario.image}" 
                 alt="${scenario.title}" class="scenario-image">
          </div>
        </div>
        ` : ''}

        <div class="worksheet-section">
          <h2 class="section-header">Questions</h2>
          <div class="questions-section">
            ${scenario.questions.map((q, index) => `
              <div class="question-item" data-question="${index + 1}">
                <div class="question-text">${index + 1}. ${q.text}</div>
                <textarea class="answer-input" data-question="${index + 1}" 
                         placeholder="${q.placeholder || 'Enter your answer here...'}"></textarea>
                <button class="submit-question-btn" onclick="submitAnswer(${index + 1})">
                  Submit Answer
                </button>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Show the content
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('main-content').style.display = 'block';
    }

    // Submit answer function for regular worksheets
    function submitAnswer(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitAnswer(${questionNum})"]`);
      
      if (textarea && button) {
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Save answer
        const worksheetId = getUrlParameter('id');
        const type = getUrlParameter('type') || 'maintenance';
        const key = `${type}_worksheet_${worksheetId}_answer_${questionNum}`;
        localStorage.setItem(key, textarea.value);
      }
    }

    // Show error message
    function showError(message) {
      document.getElementById('loading-container').style.display = 'none';
      document.getElementById('error-container').style.display = 'block';
      const errorText = document.querySelector('#error-container p');
      if (errorText) {
        errorText.textContent = message;
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to allow URL parameters to be set by main process
      setTimeout(loadWorksheet, 100);
    });

    // Initialize basic Worksheet 1 features for fallback
    function initializeBasicWorksheet1Features() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });
    }

    // Submit answer function for Worksheet 1 questions
    window.submitWorksheet1Question = function(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick="submitWorksheet1Question(${questionNum})"]`);
      const correctAnswerDiv = document.querySelector(`.question-item[data-question="${questionNum}"] .correct-answer`);
      
      if (textarea && button && correctAnswerDiv) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          alert('Please provide an answer before submitting.');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Show correct answer
        correctAnswerDiv.style.display = 'block';
        
        // Save answer
        const key = `worksheet1_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        console.log('Question', questionNum, 'submitted:', userAnswer);
      }
    };

    // Navigation function for worksheet buttons
    function navigateWorksheet(direction) {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      
      let nextId;
      if (direction === 'next') {
        nextId = currentType === 'maintenance' ? Math.min(currentId + 1, 14) : Math.min(currentId + 1, 8);
      } else if (direction === 'prev') {
        nextId = Math.max(currentId - 1, 1);
      }
      
      if (nextId && nextId !== currentId) {
        window.electron.navigate(`worksheet.html?id=${nextId}&type=${currentType}`);
      }
    }

    // Update navigation button states
    function updateNavigationButtons() {
      const currentId = parseInt(getUrlParameter('id'));
      const currentType = getUrlParameter('type') || 'maintenance';
      const maxId = currentType === 'maintenance' ? 14 : 8;
      
      const prevBtn = document.querySelector('.prev-btn');
      const nextBtn = document.querySelector('.next-btn');
      
      if (prevBtn) {
        prevBtn.disabled = currentId <= 1;
      }
      
      if (nextBtn) {
        nextBtn.disabled = currentId >= maxId;
      }
    }

    // Initialize interactive features for the enhanced worksheet
    function initializeInteractiveFeatures() {
      // Initialize step completion functionality
      const stepCards = document.querySelectorAll('.step-card');
      stepCards.forEach(card => {
        const checkbox = card.querySelector('.step-complete-checkbox');
        const stepNumber = card.dataset.step;
        
        // Load saved state
        const savedState = localStorage.getItem(`worksheet1_step${stepNumber}_complete`);
        if (savedState === 'true') {
          checkbox.checked = true;
          card.style.opacity = '0.7';
        }

        // Function to toggle step completion
        const toggleStep = (e) => {
          // Don't toggle if clicking the checkbox itself
          if (e.target.type === 'checkbox') return;
          
          checkbox.checked = !checkbox.checked;
          
          if (checkbox.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, checkbox.checked);
        };

        card.addEventListener('click', toggleStep);
        
        // Also handle checkbox changes
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            card.style.opacity = '0.7';
          } else {
            card.style.opacity = '1';
          }
          localStorage.setItem(`worksheet1_step${stepNumber}_complete`, e.target.checked);
        });
      });

      // Initialize Q&A functionality
      const submitBtns = document.querySelectorAll('.submit-question-btn');
      submitBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const questionNum = this.getAttribute('onclick').match(/\d+/)[0];
          submitInteractiveQuestion(parseInt(questionNum));
        });
      });

      // Initialize tab system
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const tabName = e.target.dataset.tab;
          switchTab(tabName);
        });
      });
    }

    // Tab switching function for PID simulation
    function switchTab(tabName) {
      // Hide all tab contents
      const tabContents = document.querySelectorAll('.tab-content');
      tabContents.forEach(content => {
        content.classList.add('hidden');
      });

      // Remove active class from all buttons
      const tabButtons = document.querySelectorAll('.tab-button');
      tabButtons.forEach(button => {
        button.classList.remove('active');
        button.style.background = '#555';
      });

      // Show selected tab content
      const selectedTab = document.getElementById(`${tabName}-tab`);
      if (selectedTab) {
        selectedTab.classList.remove('hidden');
      }

      // Add active class to selected button
      const selectedButton = document.querySelector(`[data-tab="${tabName}"]`);
      if (selectedButton) {
        selectedButton.classList.add('active');
        selectedButton.style.background = '#E91E63';
      }
    }

    // Submit question function for interactive worksheet
    function submitInteractiveQuestion(questionNum) {
      const textarea = document.querySelector(`textarea[data-question="${questionNum}"]`);
      const button = document.querySelector(`button[onclick*="${questionNum}"]`);
      const questionItem = document.querySelector(`.question-item[data-question="${questionNum}"]`);
      
      if (textarea && button && questionItem) {
        const userAnswer = textarea.value.trim();
        
        if (userAnswer === '') {
          alert('Please provide an answer before submitting.');
          return;
        }
        
        // Disable textarea and button
        textarea.disabled = true;
        button.textContent = 'Submitted';
        button.disabled = true;
        button.style.backgroundColor = '#4CAF50';
        
        // Show a simple confirmation
        const comparison = questionItem.querySelector('.individual-comparison');
        if (comparison) {
          comparison.innerHTML = `
            <div style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 4px; margin-top: 15px; border-left: 3px solid #4CAF50;">
              <strong style="color: #4CAF50;">Answer Submitted!</strong>
              <p style="color: #FFFFFF; margin: 5px 0 0 0;">Your answer has been saved. Great job working through this question!</p>
            </div>
          `;
          comparison.classList.remove('hidden');
        }
        
        // Save answer
        const key = `worksheet1_interactive_answer_${questionNum}`;
        localStorage.setItem(key, userAnswer);
        
        console.log('Interactive question', questionNum, 'submitted:', userAnswer);
      }
    }

    // Global function for Worksheet 1 questions (called from original popup code)
    window.submitQuestion = function(questionNum) {
      // This will be handled by the original popup code
      console.log('Question submitted:', questionNum);
    };
  </script>
</body>
</html> 