<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - Student Answer Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #ffffff;
            min-height: 100vh;
        }

        /* Login Screen Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 400px;
            width: 100%;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: #FF6B6B;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .login-header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: #FF6B6B;
            font-weight: 600;
            font-size: 16px;
        }

        .form-group input {
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #FF6B6B;
            box-shadow: 0 0 0 2px rgba(255, 107, 107, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .login-btn {
            background: linear-gradient(135deg, #FF6B6B, #ff5252);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #ff5252, #FF6B6B);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .login-error {
            background: rgba(244, 67, 54, 0.2);
            color: #ffcdd2;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid rgba(244, 67, 54, 0.3);
            margin-top: 10px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        .dashboard-container {
            display: none;
        }

        .dashboard-container.authenticated {
            display: block;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FF6B6B;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #FF6B6B;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #FF6B6B;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-nav {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            color: #ffffff;
        }

        .nav-tab.active {
            background: #FF6B6B;
            border-color: #FF6B6B;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analytics-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .analytics-card h3 {
            color: #FF6B6B;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.2em;
            color: #4ECDC4;
        }

        .export-controls {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .export-controls h3 {
            color: #FF6B6B;
            margin-bottom: 15px;
        }

        .export-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #FF6B6B;
            color: white;
        }

        .btn-primary:hover {
            background: #ff5252;
        }

        .btn-secondary {
            background: #4ECDC4;
            color: white;
        }

        .btn-secondary:hover {
            background: #26a69a;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .student-data-table {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-header {
            background: rgba(255, 107, 107, 0.2);
            padding: 15px 20px;
            font-weight: bold;
            color: #FF6B6B;
        }

        .table-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .table-row {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
        }

        .table-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #FF6B6B, #4ECDC4);
            transition: width 0.3s;
        }

        .file-upload {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload:hover {
            border-color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
        }

        .file-upload.dragover {
            border-color: #4ECDC4;
            background: rgba(78, 205, 196, 0.1);
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF6B6B, #ff5252);
            color: white;
            border: 2px solid #FF6B6B;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: linear-gradient(135deg, #ff5252, #FF6B6B);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
            border-color: #ff5252;
        }

        .back-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }

        .chart-container {
            height: 300px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #AAA;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-complete {
            background: #4CAF50;
            color: white;
        }

        .status-partial {
            background: #FF9800;
            color: white;
        }

        .status-none {
            background: #f44336;
            color: white;
        }

        @media (max-width: 768px) {
            .dashboard-nav {
                flex-direction: column;
                align-items: center;
            }

            .export-options {
                flex-direction: column;
                align-items: stretch;
            }

            .table-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-chalkboard-teacher"></i> Teacher Portal</h1>
                <p>Enter your credentials to access the dashboard</p>
            </div>
            
            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" placeholder="Enter username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" placeholder="Enter password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Invalid credentials. Please try again.
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Content -->
    <div id="dashboardContent" class="dashboard-container">
        <button class="logout-btn" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>

        <button class="back-button" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> Back
        </button>

        <div class="header">
            <h1><i class="fas fa-chalkboard-teacher"></i> Teacher Dashboard</h1>
            <p>Manage student answers, export data, and view learning analytics</p>
        </div>

    <div class="dashboard-nav">
        <div class="nav-tab active" onclick="switchTab('overview')">
            <i class="fas fa-chart-line"></i> Overview
        </div>
        <div class="nav-tab" onclick="switchTab('export')">
            <i class="fas fa-download"></i> Export Data
        </div>
        <div class="nav-tab" onclick="switchTab('import')">
            <i class="fas fa-upload"></i> Import Data
        </div>
        <div class="nav-tab" onclick="switchTab('analytics')">
            <i class="fas fa-chart-bar"></i> Analytics
        </div>
    </div>

    <div class="content">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3><i class="fas fa-users"></i> Student Summary</h3>
                    <div class="metric">
                        <span>Total Questions</span>
                        <span class="metric-value" id="totalQuestions">0</span>
                    </div>
                    <div class="metric">
                        <span>Answered Questions</span>
                        <span class="metric-value" id="answeredQuestions">0</span>
                    </div>
                    <div class="metric">
                        <span>Completion Rate</span>
                        <span class="metric-value" id="completionRate">0%</span>
                    </div>
                    <div class="metric">
                        <span>Last Activity</span>
                        <span class="metric-value" id="lastActivity">Never</span>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-clipboard-list"></i> Worksheet Breakdown</h3>
                    <div class="metric">
                        <span>Maintenance Worksheets</span>
                        <span class="metric-value" id="maintenanceCount">14</span>
                    </div>
                    <div class="metric">
                        <span>Fault Scenarios</span>
                        <span class="metric-value" id="faultCount">8</span>
                    </div>
                    <div class="metric">
                        <span>Questions per Worksheet</span>
                        <span class="metric-value">3</span>
                    </div>
                    <div class="metric">
                        <span>Average Completion</span>
                        <span class="metric-value" id="avgCompletion">0%</span>
                    </div>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-trophy"></i> Performance Metrics</h3>
                    <div class="metric">
                        <span>Best Performing Topic</span>
                        <span class="metric-value" id="bestTopic">-</span>
                    </div>
                    <div class="metric">
                        <span>Needs Attention</span>
                        <span class="metric-value" id="needsAttention">-</span>
                    </div>
                    <div class="metric">
                        <span>Most Recent Activity</span>
                        <span class="metric-value" id="recentActivity">-</span>
                    </div>
                    <div class="metric">
                        <span>Study Time Estimate</span>
                        <span class="metric-value" id="studyTime">-</span>
                    </div>
                </div>
            </div>

            <div class="student-data-table">
                <div class="table-header">
                    <i class="fas fa-table"></i> Detailed Question Progress
                </div>
                <div class="table-content" id="questionProgressTable">
                    <!-- Question progress will be populated here -->
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="export-controls">
                <h3><i class="fas fa-download"></i> Export Student Data</h3>
                <div class="export-options">
                    <button class="btn btn-primary" onclick="exportDetailedJSON()">
                        <i class="fas fa-file-code"></i> Detailed JSON
                    </button>
                    <button class="btn btn-secondary" onclick="exportSummaryCSV()">
                        <i class="fas fa-file-csv"></i> Summary CSV
                    </button>
                    <button class="btn btn-success" onclick="exportFullCSV()">
                        <i class="fas fa-table"></i> Full Data CSV
                    </button>
                    <button class="btn btn-warning" onclick="exportTeacherReport()">
                        <i class="fas fa-file-pdf"></i> Teacher Report
                    </button>
                </div>
            </div>

            <div class="analytics-card">
                <h3><i class="fas fa-info-circle"></i> Export Information</h3>
                <p><strong>Detailed JSON:</strong> Complete student data including all answers, timestamps, and metadata. Best for data analysis and backup.</p>
                <p><strong>Summary CSV:</strong> Overview of completion rates by worksheet. Good for quick assessment.</p>
                <p><strong>Full Data CSV:</strong> All questions and answers in spreadsheet format. Perfect for detailed review.</p>
                <p><strong>Teacher Report:</strong> Formatted report with analytics and recommendations. Ready for printing or sharing.</p>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="import" class="tab-content">
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept=".json,.csv" onchange="handleFileUpload(event)">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3em; margin-bottom: 15px; color: #FF6B6B;"></i>
                <h3>Import Student Data</h3>
                <p>Click here or drag and drop JSON or CSV files</p>
                <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                    Supported formats: JSON (from exports), CSV (question data)
                </p>
            </div>

            <div class="analytics-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Import Guidelines</h3>
                <ul style="line-height: 1.6;">
                    <li>JSON files must be in the format exported by this system</li>
                    <li>CSV files should have headers: WorksheetType, WorksheetID, QuestionID, Answer, Timestamp</li>
                    <li>Importing will merge with existing data (not replace)</li>
                    <li>Duplicate answers will be updated with the most recent timestamp</li>
                    <li>Always backup current data before importing</li>
                </ul>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h3><i class="fas fa-chart-pie"></i> Completion by Topic</h3>
                    <div id="topicCompletion">
                        <!-- Will be populated with topic completion data -->
                    </div>
                </div>

                <div class="analytics-card">
                    <h3><i class="fas fa-clock"></i> Activity Timeline</h3>
                    <div id="activityTimeline">
                        <!-- Will be populated with timeline data -->
                    </div>
                </div>
            </div>

            <div class="chart-container">
                <div style="text-align: center;">
                    <i class="fas fa-chart-line" style="font-size: 4em; margin-bottom: 20px;"></i>
                    <h3>Advanced Analytics</h3>
                    <p>Detailed charts and visualizations will be displayed here</p>
                    <p style="font-size: 0.9em; opacity: 0.7;">Feature coming soon - currently showing summary data above</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let worksheetData = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            await loadWorksheetData();
            updateOverview();
            setupFileUpload();
        });

        // Load worksheet data
        async function loadWorksheetData() {
            try {
                const [maintenanceResponse, faultResponse] = await Promise.all([
                    fetch('dbMaintenanceScenarios.json'),
                    fetch('dbFaultScenarios.json')
                ]);
                
                const maintenanceData = await maintenanceResponse.json();
                const faultData = await faultResponse.json();
                
                worksheetData = {
                    maintenance: maintenanceData.scenarios,
                    fault: faultData.scenarios
                };
            } catch (error) {
                console.error('Error loading worksheet data:', error);
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Update content based on tab
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }

        // Update overview
        function updateOverview() {
            const data = collectAllStudentData();
            
            // Update summary metrics
            document.getElementById('totalQuestions').textContent = data.totalQuestions;
            document.getElementById('answeredQuestions').textContent = data.answeredQuestions;
            document.getElementById('completionRate').textContent = data.completionRate + '%';
            document.getElementById('lastActivity').textContent = data.lastActivity;
            
            // Update worksheet breakdown
            document.getElementById('avgCompletion').textContent = data.avgCompletion + '%';
            
            // Update performance metrics
            document.getElementById('bestTopic').textContent = data.bestTopic;
            document.getElementById('needsAttention').textContent = data.needsAttention;
            document.getElementById('recentActivity').textContent = data.recentActivity;
            document.getElementById('studyTime').textContent = data.studyTime;
            
            // Update question progress table
            updateQuestionProgressTable(data.questionDetails);
        }

        // Collect all student data
        function collectAllStudentData() {
            if (!worksheetData) return getEmptyData();
            
            let totalQuestions = 0;
            let answeredQuestions = 0;
            let lastActivity = null;
            let questionDetails = [];
            let topicScores = {};
            
            // Process maintenance worksheets
            worksheetData.maintenance.forEach(worksheet => {
                const answers = getWorksheetAnswers(worksheet, 'maintenance');
                const worksheetAnswered = answers.filter(a => a.answer).length;
                
                totalQuestions += worksheet.questions.length;
                answeredQuestions += worksheetAnswered;
                
                topicScores[worksheet.title] = {
                    answered: worksheetAnswered,
                    total: worksheet.questions.length,
                    rate: Math.round((worksheetAnswered / worksheet.questions.length) * 100)
                };
                
                worksheet.questions.forEach((question, index) => {
                    const answer = answers[index];
                    if (answer.timestamp) {
                        const timestamp = new Date(answer.timestamp);
                        if (!lastActivity || timestamp > lastActivity) {
                            lastActivity = timestamp;
                        }
                    }
                    
                    questionDetails.push({
                        type: 'Maintenance',
                        id: worksheet.id,
                        title: worksheet.title,
                        questionId: question.id,
                        questionText: question.text,
                        answered: !!answer.answer,
                        timestamp: answer.timestamp
                    });
                });
            });
            
            // Process fault scenarios
            worksheetData.fault.forEach(worksheet => {
                const answers = getWorksheetAnswers(worksheet, 'fault');
                const worksheetAnswered = answers.filter(a => a.answer).length;
                
                totalQuestions += worksheet.questions.length;
                answeredQuestions += worksheetAnswered;
                
                topicScores[worksheet.title] = {
                    answered: worksheetAnswered,
                    total: worksheet.questions.length,
                    rate: Math.round((worksheetAnswered / worksheet.questions.length) * 100)
                };
                
                worksheet.questions.forEach((question, index) => {
                    const answer = answers[index];
                    if (answer.timestamp) {
                        const timestamp = new Date(answer.timestamp);
                        if (!lastActivity || timestamp > lastActivity) {
                            lastActivity = timestamp;
                        }
                    }
                    
                    questionDetails.push({
                        type: 'Fault',
                        id: worksheet.id,
                        title: worksheet.title,
                        questionId: question.id,
                        questionText: question.text,
                        answered: !!answer.answer,
                        timestamp: answer.timestamp
                    });
                });
            });
            
            // Calculate metrics
            const completionRate = totalQuestions > 0 ? Math.round((answeredQuestions / totalQuestions) * 100) : 0;
            const avgCompletion = Object.values(topicScores).reduce((sum, topic) => sum + topic.rate, 0) / Object.keys(topicScores).length;
            
            // Find best and worst topics
            const sortedTopics = Object.entries(topicScores).sort((a, b) => b[1].rate - a[1].rate);
            const bestTopic = sortedTopics[0] ? sortedTopics[0][0] : 'None';
            const needsAttention = sortedTopics[sortedTopics.length - 1] ? sortedTopics[sortedTopics.length - 1][0] : 'None';
            
            return {
                totalQuestions,
                answeredQuestions,
                completionRate,
                avgCompletion: Math.round(avgCompletion),
                lastActivity: lastActivity ? lastActivity.toLocaleDateString() : 'Never',
                bestTopic,
                needsAttention,
                recentActivity: lastActivity ? getRelativeTime(lastActivity) : 'Never',
                studyTime: estimateStudyTime(answeredQuestions),
                questionDetails,
                topicScores
            };
        }

        // Get empty data structure
        function getEmptyData() {
            return {
                totalQuestions: 0,
                answeredQuestions: 0,
                completionRate: 0,
                avgCompletion: 0,
                lastActivity: 'Never',
                bestTopic: 'None',
                needsAttention: 'None',
                recentActivity: 'Never',
                studyTime: '0 min',
                questionDetails: [],
                topicScores: {}
            };
        }

        // Get worksheet answers
        function getWorksheetAnswers(worksheet, type) {
            const answers = [];
            
            worksheet.questions.forEach((question, index) => {
                const questionNum = index + 1;
                let answer = null;
                let timestamp = null;
                
                if (type === 'maintenance') {
                    const key1 = `maintenance_worksheet_${worksheet.id}_answer_${questionNum}`;
                    const key2 = `worksheet${worksheet.id}_answer_${questionNum}`;
                    const key3 = `worksheet${worksheet.id}_interactive_answer_${questionNum}`;
                    
                    answer = localStorage.getItem(key1) || localStorage.getItem(key2) || localStorage.getItem(key3);
                    timestamp = localStorage.getItem(`${key1}_timestamp`);
                } else {
                    const key = `fault_worksheet_${worksheet.id}_answer_${questionNum}`;
                    answer = localStorage.getItem(key);
                    timestamp = localStorage.getItem(`${key}_timestamp`);
                }
                
                answers.push({
                    answer: answer,
                    timestamp: timestamp
                });
            });
            
            return answers;
        }

        // Update question progress table
        function updateQuestionProgressTable(questionDetails) {
            const table = document.getElementById('questionProgressTable');
            
            if (questionDetails.length === 0) {
                table.innerHTML = '<div style="padding: 20px; text-align: center; color: #AAA;">No student data available</div>';
                return;
            }
            
            const html = questionDetails.map(question => {
                const status = question.answered ? 'Complete' : 'Incomplete';
                const statusClass = question.answered ? 'status-complete' : 'status-none';
                const timestamp = question.timestamp ? new Date(question.timestamp).toLocaleString() : 'Never';
                
                return `
                    <div class="table-row">
                        <div>
                            <strong>${question.type} ${question.id}</strong><br>
                            <small>${question.title}</small>
                        </div>
                        <div>
                            <small>${question.questionId}</small><br>
                            ${question.questionText.substring(0, 50)}...
                        </div>
                        <div>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </div>
                        <div>
                            <small>${timestamp}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            table.innerHTML = html;
        }

        // Update analytics
        function updateAnalytics() {
            const data = collectAllStudentData();
            
            // Update topic completion
            const topicCompletion = document.getElementById('topicCompletion');
            const topicHtml = Object.entries(data.topicScores).map(([topic, score]) => {
                return `
                    <div class="metric">
                        <span>${topic.substring(0, 20)}...</span>
                        <span class="metric-value">${score.rate}%</span>
                    </div>
                `;
            }).join('');
            topicCompletion.innerHTML = topicHtml;
            
            // Update activity timeline
            const activityTimeline = document.getElementById('activityTimeline');
            const recentAnswers = data.questionDetails
                .filter(q => q.timestamp)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const timelineHtml = recentAnswers.map(answer => {
                return `
                    <div class="metric">
                        <span>${answer.type} ${answer.id}</span>
                        <span class="metric-value">${getRelativeTime(new Date(answer.timestamp))}</span>
                    </div>
                `;
            }).join('');
            
            activityTimeline.innerHTML = timelineHtml || '<div style="text-align: center; color: #AAA; padding: 20px;">No recent activity</div>';
        }

        // Export functions
        function exportDetailedJSON() {
            const data = collectAllStudentData();
            const exportData = {
                exportDate: new Date().toISOString(),
                exportType: 'detailed',
                studentData: data,
                rawAnswers: getAllRawAnswers()
            };
            
            downloadFile(JSON.stringify(exportData, null, 2), 'student-data-detailed.json', 'application/json');
        }

        function exportSummaryCSV() {
            const data = collectAllStudentData();
            const headers = ['Worksheet Type', 'Worksheet ID', 'Title', 'Questions Answered', 'Total Questions', 'Completion Rate'];
            
            const rows = [];
            if (worksheetData) {
                worksheetData.maintenance.forEach(worksheet => {
                    const answers = getWorksheetAnswers(worksheet, 'maintenance');
                    const answered = answers.filter(a => a.answer).length;
                    const rate = Math.round((answered / worksheet.questions.length) * 100);
                    
                    rows.push([
                        'Maintenance',
                        worksheet.id,
                        worksheet.title,
                        answered,
                        worksheet.questions.length,
                        rate + '%'
                    ]);
                });
                
                worksheetData.fault.forEach(worksheet => {
                    const answers = getWorksheetAnswers(worksheet, 'fault');
                    const answered = answers.filter(a => a.answer).length;
                    const rate = Math.round((answered / worksheet.questions.length) * 100);
                    
                    rows.push([
                        'Fault',
                        worksheet.id,
                        worksheet.title,
                        answered,
                        worksheet.questions.length,
                        rate + '%'
                    ]);
                });
            }
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            downloadFile(csv, 'student-summary.csv', 'text/csv');
        }

        function exportFullCSV() {
            const data = collectAllStudentData();
            const headers = ['Type', 'Worksheet ID', 'Title', 'Question ID', 'Question Text', 'Answer', 'Timestamp', 'Status'];
            
            const rows = data.questionDetails.map(question => [
                question.type,
                question.id,
                question.title,
                question.questionId,
                `"${question.questionText.replace(/"/g, '""')}"`,
                `"${getAnswerText(question).replace(/"/g, '""')}"`,
                question.timestamp || '',
                question.answered ? 'Answered' : 'Unanswered'
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            downloadFile(csv, 'student-full-data.csv', 'text/csv');
        }

        function exportTeacherReport() {
            const data = collectAllStudentData();
            const report = generateTeacherReport(data);
            downloadFile(report, 'teacher-report.html', 'text/html');
        }

        // Helper functions
        function getAllRawAnswers() {
            const rawAnswers = {};
            const keys = Object.keys(localStorage);
            
            keys.forEach(key => {
                if (key.includes('_answer_') || key.includes('worksheet')) {
                    rawAnswers[key] = localStorage.getItem(key);
                }
            });
            
            return rawAnswers;
        }

        function getAnswerText(question) {
            if (!worksheetData) return '';
            
            const type = question.type.toLowerCase();
            const worksheets = worksheetData[type];
            const worksheet = worksheets.find(w => w.id === question.id);
            
            if (!worksheet) return '';
            
            const answers = getWorksheetAnswers(worksheet, type);
            const questionIndex = worksheet.questions.findIndex(q => q.id === question.questionId);
            
            return answers[questionIndex]?.answer || '';
        }

        function getRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor(diff / (1000 * 60));
            
            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return 'Just now';
        }

        function estimateStudyTime(answeredQuestions) {
            const avgTimePerQuestion = 3; // minutes
            const totalTime = answeredQuestions * avgTimePerQuestion;
            
            if (totalTime < 60) return `${totalTime} min`;
            return `${Math.round(totalTime / 60)} hr ${totalTime % 60} min`;
        }

        function generateTeacherReport(data) {
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Student Progress Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .metric { margin: 10px 0; }
                        .progress-bar { width: 100px; height: 20px; background: #eee; display: inline-block; }
                        .progress-fill { height: 100%; background: #4CAF50; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Student Progress Report</h1>
                        <p>Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <h2>Summary</h2>
                    <div class="metric">Total Questions: ${data.totalQuestions}</div>
                    <div class="metric">Answered Questions: ${data.answeredQuestions}</div>
                    <div class="metric">Completion Rate: ${data.completionRate}%</div>
                    <div class="metric">Last Activity: ${data.lastActivity}</div>
                    
                    <h2>Topic Performance</h2>
                    ${Object.entries(data.topicScores).map(([topic, score]) => `
                        <div class="metric">
                            ${topic}: ${score.answered}/${score.total} (${score.rate}%)
                        </div>
                    `).join('')}
                    
                    <h2>Recommendations</h2>
                    <ul>
                        <li>Focus on topics with low completion rates</li>
                        <li>Encourage regular study sessions</li>
                        <li>Review answered questions for understanding</li>
                    </ul>
                </body>
                </html>
            `;
        }

        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // File upload handling
        function setupFileUpload() {
            const fileUpload = document.querySelector('.file-upload');
            
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.classList.add('dragover');
            });
            
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.classList.remove('dragover');
            });
            
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileUpload({ target: { files } });
                }
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    if (file.name.endsWith('.json')) {
                        const data = JSON.parse(content);
                        importJSONData(data);
                    } else if (file.name.endsWith('.csv')) {
                        importCSVData(content);
                    } else {
                        showInlineNotification('Unsupported file format. Please use JSON or CSV files.', 'error');
                    }
                } catch (error) {
                    showInlineNotification('Error reading file: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }

        function importJSONData(data) {
            // Implementation for importing JSON data
            console.log('Importing JSON data:', data);
            showInlineNotification('JSON import functionality will be implemented based on your specific needs.', 'info');
        }

        function importCSVData(content) {
            // Implementation for importing CSV data
            console.log('Importing CSV data:', content);
            showInlineNotification('CSV import functionality will be implemented based on your specific needs.', 'info');
        }

        // Go back to main menu
        function goBack() {
            if (window.electron) {
                window.electron.navigate('index.html');
            } else {
                window.location.href = 'index.html';
            }
        }

        // Authentication functions
        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            
            // Reset error state
            loginError.classList.remove('show');
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            // Simulate loading delay for better UX
            setTimeout(() => {
                // Check credentials
                if (username === 'Matrix' && password === 'Matrix123') {
                    // Successful login
                    sessionStorage.setItem('teacherAuthenticated', 'true');
                    showDashboard();
                } else {
                    // Failed login
                    loginError.classList.add('show');
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                    
                    // Clear password field
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }
            }, 1000);
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardContent').classList.add('authenticated');
            
            // Initialize dashboard data
            loadWorksheetData();
        }

        function logout() {
            sessionStorage.removeItem('teacherAuthenticated');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardContent').classList.remove('authenticated');
            
            // Clear form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').classList.remove('show');
            document.getElementById('loginBtn').disabled = false;
            document.getElementById('loginBtn').innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
        }

        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('teacherAuthenticated') === 'true';
            
            if (isAuthenticated) {
                showDashboard();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboardContent').classList.remove('authenticated');
            }
        }

        // Initialize authentication check when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            
            // Add Enter key support for login form
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleLogin(e);
                }
            });
        });

        // Inline Notification Functions (no focus issues)
        function showInlineNotification(message, type = 'info', duration = 4000) {
            const existingNotification = document.querySelector('.inline-notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `inline-notification ${type}`;
            
            notification.innerHTML = `
                <button class="notification-close" onclick="this.parentElement.remove()">×</button>
                <div class="notification-message">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.classList.add('fade-out');
                        setTimeout(() => {
                            if (notification.parentElement) {
                                notification.remove();
                            }
                        }, 300);
                    }
                }, duration);
            }
        }
    </script>
    </div> <!-- Close dashboard-container -->
</body>
</html> 