<!DOCTYPE html>
<html>
<head>
    <title>PLC Details View</title>
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #2c3033;
            color: white;
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        .container {
            padding: 0 30px;  /* 30px padding on left and right */
            width: calc(100% - 60px);  /* Adjust for padding */
            max-width: 100%;
            margin: 0 auto;
        }

        .section {
            width: 100%;
            overflow-x: hidden;
        }

        .section-title {
            color: #9da5b1;
        }

        /* Make the table columns equal width */
        #plc-tags-table th,
        #plc-tags-table td {
            width: 25%;
        }

        .modify-btn:hover {
            background-color: #0056b3 !important;
        }

        /* Add these styles */
        #plc-analogue-table {
            width: 100% !important;
            margin: 0 !important;
        }

        /* Adjust column widths */
        #plc-analogue-table th:nth-child(1),
        #plc-analogue-table th:nth-child(4) {  /* Name columns */
            width: 25% !important;
        }
        
        #plc-analogue-table th:nth-child(2),
        #plc-analogue-table th:nth-child(5) {  /* Value columns */
            width: 15% !important;
        }
        
        #plc-analogue-table th:nth-child(3),
        #plc-analogue-table th:nth-child(6) {  /* Action columns */
            width: 10% !important;
        }

        /* Control table width */
        #plc-digital-table {
            width: 100% !important;
            margin: 0 !important;
        }

        /* Remove horizontal scroll */
        .dataTables_wrapper {
            width: 100%;
            overflow-x: hidden;
        }

        /* Ensure sections don't overflow */
        .section {
            width: 100%;
            overflow-x: hidden;
        }

        /* Add some spacing between tables */
        .section + .section {
            margin-top: 30px;
        }

        .force-btn:first-child:hover {
            background-color: #c82333 !important;
        }
        .force-btn:last-child:hover {
            background-color: #7d0915 !important;
        }

        /* Ensure tables respect column widths */
        #plc-analogue-table, #plc-digital-table {
            table-layout: fixed;
        }

        /* Handle text overflow in name columns */
        #plc-analogue-table td, #plc-digital-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Ensure action columns can fit the force buttons */
        #plc-analogue-table td:nth-child(3),
        #plc-analogue-table td:nth-child(6),
        #plc-digital-table td:nth-child(3),
        #plc-digital-table td:nth-child(6) {
            padding: 5px;
            white-space: normal;
        }

        /* Increase cell padding to accommodate larger buttons */
        #plc-analogue-table td,
        #plc-digital-table td {
            padding: 8px 5px;
            vertical-align: middle;
        }

        /* Button hover states */
        .force-btn:first-child:hover {
            background-color: #c82333 !important;
        }
        .force-btn:last-child:hover {
            background-color: #7d0915 !important;
        }
        .special-btn.btn-success:hover {
            background-color: #218838 !important;
        }
        .special-btn.btn-primary:hover {
            background-color: #0056b3 !important;
        }
        .modify-btn:hover {
            background-color: #0056b3 !important;
        }

        /* Ensure buttons maintain height and width */
        .btn {
            line-height: 1.2;
            min-height: 35px;
            width: 85px !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Button hover states */
        .force-btn:hover,
        .special-btn:hover,
        .modify-btn:hover {
            opacity: 1 !important;  /* Full opacity on hover */
        }

        /* Force buttons */
        .force-btn-on:hover {
            opacity: 1;
            background-color: #dc3545 !important;
        }
        .force-btn-off:hover {
            opacity: 1;
            background-color: #9a0c1c !important;
        }

        /* Special buttons */
        .special-btn-clear:hover {
            opacity: 1;
            background-color: #28a745 !important;
        }
        .special-btn-reset:hover {
            opacity: 1;
            background-color: #007bff !important;
        }

        /* Modify button */
        .modify-btn:hover {
            opacity: 1;
            background-color: #007bff !important;
        }

        /* Ensure buttons maintain height and width */
        .btn {
            line-height: 1.2;
            min-height: 35px;
            width: 85px !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .modify-btn {
            padding: 8px 12px;
            font-size: 0.9em;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            min-height: 35px;
            width: 85px !important;
            opacity: 0.7;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
        }

        .modify-btn:hover {
            opacity: 1 !important;
        }

        /* Force On button - lighter red */
        .force-on:hover {
            background-color: #dc3545 !important;
        }

        /* Force Off button - darker red */
        .force-off:hover {
            background-color: #9a0c1c !important;
        }

        /* Clear button - green */
        .clear-btn:hover {
            background-color: #28a745 !important;
        }

        /* Reset button - blue */
        .reset-btn:hover {
            background-color: #007bff !important;
        }

        /* Modify button - blue */
        .modify-btn:not(.force-on):not(.force-off):not(.clear-btn):not(.reset-btn):hover {
            background-color: #007bff !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="section">
            <h2 class="section-title">Analogue I/O</h2>
            <table id="plc-analogue-table" class="display">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value / State</th>
                        <th>Action</th>
                        <th>Name</th>
                        <th>Value / State</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="section" style="margin-top: 30px;">
            <h2 class="section-title">Digital I/O</h2>
            <table id="plc-digital-table" class="display">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value / State</th>
                        <th>Action</th>
                        <th>Name</th>
                        <th>Value / State</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function() {
            const analogueTable = $('#plc-analogue-table').DataTable({
                pageLength: 50,
                dom: 'ft',
                theme: 'dark',
                escapeHtml: false,
                searching: true,
                ordering: false,
                autoWidth: false,
                columnDefs: [
                    { width: '30%', targets: 0 },     // Left Name column
                    { width: '10%', targets: 1 },     // Left Value column
                    { width: '10%', targets: 2 },     // Left Action column
                    { width: '30%', targets: 3 },     // Right Name column
                    { width: '10%', targets: 4 },     // Right Value column
                    { width: '10%', targets: 5 }      // Right Action column
                ]
            });

            const digitalTable = $('#plc-digital-table').DataTable({
                pageLength: 50,
                dom: 'ft',
                theme: 'dark',
                escapeHtml: false,
                searching: true,
                ordering: false,
                autoWidth: false,
                columnDefs: [
                    { width: '20%', targets: 0 },     // Left Name column
                    { width: '10%', targets: 1 },     // Left Value column
                    { width: '20%', targets: 2 },     // Left Action column
                    { width: '20%', targets: 3 },     // Right Name column
                    { width: '10%', targets: 4 },     // Right Value column
                    { width: '20%', targets: 5 }      // Right Action column
                ]
            });

            function createModifyButton(type, channel) {
                return `<div style="display: flex; justify-content: center;">
                            <button class="btn btn-sm modify-btn" 
                                    onclick="modifyValue('${type}', ${channel})"
                                    style="padding: 8px 12px; font-size: 0.9em; background-color: #007bff; 
                                           color: white; border: none; border-radius: 3px; min-height: 35px; width: 85px;
                                           opacity: 0.7;">
                                Modify
                            </button>
                        </div>`;
            }

            function createForceButton(type, bank, channel) {
                return `<div style="display: flex; gap: 5px; justify-content: center;">
                            <button class="btn btn-sm modify-btn force-on" 
                                    onclick="forceDigital('${type}', '${bank}', ${channel}, true)"
                                    style="background-color: #dc3545;">
                                Force On
                            </button>
                            <button class="btn btn-sm modify-btn force-off" 
                                    onclick="forceDigital('${type}', '${bank}', ${channel}, false)"
                                    style="background-color: #9a0c1c;">
                                Force Off
                            </button>
                        </div>`;
            }

            function createSpecialButton(action) {
                const buttonText = action === 'clear' ? 'Clear' : 'Reset';
                const buttonColor = action === 'clear' ? '#28a745' : '#007bff';
                const buttonClass = action === 'clear' ? 'clear-btn' : 'reset-btn';
                
                return `<div style="display: flex; justify-content: center;">
                            <button class="btn btn-sm modify-btn ${buttonClass}" 
                                    style="background-color: ${buttonColor};">
                                ${buttonText}
                            </button>
                        </div>`;
            }

            function updatePLCTags(data) {
                analogueTable.clear();
                digitalTable.clear();
                
                // Format analogue data
                const analogueData = [];
                
                // AI0
                analogueData.push([
                    'AI0 Scaled',
                    `<span style="color: #4caf50; font-weight: bold; font-size: 1.1em">${data.analogue.ai0.scaled.toFixed(2)} V</span>`,
                    '',  // No modify button for scaled value
                    'AI1 Scaled',
                    `<span style="color: #4caf50; font-weight: bold; font-size: 1.1em">${data.analogue.ai1.scaled.toFixed(2)} V</span>`,
                    ''   // No modify button for scaled value
                ]);
                
                analogueData.push([
                    'AI0 Offset',
                    data.analogue.ai0.offset.toFixed(2),
                    createModifyButton('offset', 0),
                    'AI1 Offset',
                    data.analogue.ai1.offset.toFixed(2),
                    createModifyButton('offset', 1)
                ]);
                
                analogueData.push([
                    'AI0 Scalar',
                    data.analogue.ai0.scalar.toFixed(2),
                    createModifyButton('scalar', 0),
                    'AI1 Scalar',
                    data.analogue.ai1.scalar.toFixed(2),
                    createModifyButton('scalar', 1)
                ]);
                
                analogueData.push([
                    'AI0 Raw',
                    data.analogue.ai0.raw,
                    '',  // No modify button for raw value
                    'AI1 Raw',
                    data.analogue.ai1.raw,
                    ''   // No modify button for raw value
                ]);

                // Add all rows to the table
                analogueData.forEach(row => {
                    analogueTable.row.add(row);
                });

                analogueTable.draw();

                // Format digital data
                const digitalData = [];
                const formatBoolValue = (value) => {
                    return value 
                        ? '<span style="color: #4caf50; font-weight: bold;">ON</span>' 
                        : '<span style="color: #f44336; font-weight: bold;">OFF</span>';
                };

                // Create arrays for inputs and outputs
                const inputs = [];
                const outputs = [];

                // Add Digital Inputs to left side
                for (let i = 0; i < 8; i++) {
                    inputs.push([
                        `DI A${i}`, 
                        formatBoolValue(data.inputs.a[i].state),
                        createForceButton('input', 'a', i)
                    ]);
                }
                for (let i = 0; i < 6; i++) {
                    inputs.push([
                        `DI B${i}`, 
                        formatBoolValue(data.inputs.b[i].state),
                        createForceButton('input', 'b', i)
                    ]);
                }

                // Add Digital Outputs and HMI buttons to right side
                for (let i = 0; i < 8; i++) {
                    outputs.push([
                        `DO A${i}`, 
                        formatBoolValue(data.outputs.a[i].state),
                        createForceButton('output', 'a', i)
                    ]);
                }
                for (let i = 0; i < 2; i++) {
                    outputs.push([
                        `DO B${i}`, 
                        formatBoolValue(data.outputs.b[i].state),
                        createForceButton('output', 'b', i)
                    ]);
                }
                
                // Add HMI Buttons with special actions
                outputs.push([
                    'Clear Forcing', 
                    formatBoolValue(data.hmiButtons.clearForcing),
                    createSpecialButton('clear')
                ]);
                outputs.push([
                    'Fault Reset', 
                    formatBoolValue(data.hmiButtons.faultReset),
                    createSpecialButton('reset')
                ]);

                // Find the longer array to determine how many rows we need
                const maxRows = Math.max(inputs.length, outputs.length);

                // Create rows with inputs on left, outputs on right
                for (let i = 0; i < maxRows; i++) {
                    const input = inputs[i] || ['', '', ''];  // Empty if no more inputs
                    const output = outputs[i] || ['', '', '']; // Empty if no more outputs
                    
                    digitalTable.row.add([
                        input[0],   // Input name
                        input[1],   // Input value
                        input[2],   // Input action
                        output[0],  // Output name
                        output[1],  // Output value
                        output[2]   // Output action
                    ]);
                }

                digitalTable.draw();
            }

            // Add this function to handle the modify button clicks
            window.modifyValue = function(type, channel) {
                const currentValue = type === 'offset' 
                    ? data.analogue[`ai${channel}`].offset 
                    : data.analogue[`ai${channel}`].scalar;
                    
                const newValue = prompt(`Enter new ${type} value for AI${channel}:`, currentValue);
                    
                if (newValue !== null && !isNaN(newValue)) {
                    // Send to main process
                    window.electron.sendToMain('modify-analogue', {
                        channel: channel,
                        type: type,
                        value: parseFloat(newValue)
                    });
                }
            };

            // Add these functions to handle the button clicks
            window.forceDigital = function(type, bank, channel, state) {
                window.electron.sendToMain('force-digital', {
                    type: type,
                    bank: bank,
                    channel: channel,
                    state: state
                });
            };

            window.handleSpecial = function(action) {
                if (!window.electron?.sendToMain) {
                    console.error('sendToMain is not available');
                    return;
                }

                // Send to main process with state = true to turn ON the bit
                window.electron.sendToMain('special-action', {
                    action: action,
                    state: true
                });

                // Set a timeout to turn OFF the bit after 500ms
                setTimeout(() => {
                    window.electron.sendToMain('special-action', {
                        action: action,
                        state: false
                    });
                }, 500);
            };

            // Use the correct IPC channel name that matches your main process
            window.electron.receiveData((data) => {
                updatePLCTags(data);
            });
        });
    </script>
</body>
</html>
